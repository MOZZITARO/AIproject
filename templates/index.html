<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>냉장고 채우기</title>
  <style>
    /* 기본 폰트와 배경 */
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #f5f6fa;
      margin: 0;
      padding: 20px;
      color: #333;
      line-height: 1.5;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: #fff;
      padding: 30px 40px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-radius: 12px;
    }

    .header {
      font-size: 2.2rem;
      font-weight: 700;
      margin-bottom: 30px;
      text-align: center;
      color: #2c3e50;
      letter-spacing: 1.2px;
    }

    a {
      display: inline-block;
      text-decoration: none;
      color: #3498db;
      font-weight: 700;
      margin-bottom: 25px;
      transition: color 0.3s;
    }
    a:hover {
      color: #1d6fa5;
    }

    /* 폼 섹션 */
    .form-section {
      margin-bottom: 35px;
    }

    .form-row {
      display: flex;
      gap: 25px;
      flex-wrap: wrap;
    }

    .form-group {
      flex: 1 1 45%;
      display: flex;
      flex-direction: column;
    }

    label {
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 1rem;
      color: #34495e;
    }

    input[type="text"], input[type="date"] {
      padding: 12px 15px;
      font-size: 1rem;
      border: 1.8px solid #ccc;
      border-radius: 8px;
      transition: border-color 0.3s, box-shadow 0.2s;
      font-weight: 500;
    }

    input[type="text"]:focus, input[type="date"]:focus {
      border-color: #3498db;
      box-shadow: 0 0 6px #3498dbaa;
      outline: none;
    }

    /* 액션 버튼 섹션 */
    .action-button-section {
      margin-top: 20px;
      text-align: right;
    }

    button.btn-register,
    button.btn-view {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 12px 22px;
      font-size: 1rem;
      font-weight: 700;
      border-radius: 8px;
      cursor: pointer;
      margin-left: 12px;
      transition: background-color 0.3s, box-shadow 0.2s;
      box-shadow: 0 3px 8px #3498dbaa;
      user-select: none;
    }
    button.btn-register:hover,
    button.btn-view:hover {
      background-color: #2980b9;
      box-shadow: 0 5px 14px #2980b9cc;
    }

    button[type="button"]:not(.btn-register):not(.btn-view) {
      background-color: #7f8c8d;
      color: white;
      border: none;
      padding: 12px 22px;
      font-size: 1rem;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      margin-left: 12px;
      transition: background-color 0.3s;
      box-shadow: 0 3px 6px #7f8c8daa;
      user-select: none;
    }
    button[type="button"]:not(.btn-register):not(.btn-view):hover {
      background-color: #707b7c;
      box-shadow: 0 5px 12px #707b7ccc;
    }

    /* 테이블 스타일 */
    .table-container {
      border: 1.5px solid #ddd;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.07);
    }

    .table-header,
    .table-row {
      display: grid;
      grid-template-columns: 40px 1fr 160px 180px;
      align-items: center;
      padding: 14px 20px;
      border-bottom: 1.5px solid #ddd;
      font-weight: 600;
      font-size: 1rem;
      color: #2c3e50;
      user-select: none;
    }

    .table-header {
      background-color: #3498db;
      color: #fff;
      font-weight: 700;
    }

    .table-row:nth-child(even) {
      background-color: #f4f6f8;
    }

    .table-row button {
      background-color: #e74c3c;
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 700;
      transition: background-color 0.3s, box-shadow 0.2s;
      box-shadow: 0 3px 8px #e74c3caa;
      user-select: none;
    }

    .table-row button:hover {
      background-color: #c0392b;
      box-shadow: 0 5px 14px #c0392bcc;
    }

    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: #3498db;
    }

    /* 하단 버튼 영역 */
    .bottom-section {
      margin-top: 40px;
      display: flex;
      justify-content: center;
      gap: 28px;
      flex-wrap: wrap;
    }

    .bottom-btn {
      background-color: #27ae60;
      color: white;
      border: none;
      padding: 14px 26px;
      font-size: 1.1rem;
      font-weight: 700;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 4px 12px #27ae60cc;
      transition: background-color 0.3s, box-shadow 0.3s;
      min-width: 240px;
      user-select: none;
    }
    .bottom-btn:hover {
      background-color: #1e8449;
      box-shadow: 0 6px 18px #1e8449cc;
    }

    /* 레시피 결과 */
    #recipe-check-result p {
      background: #dff0d8;
      border: 1.5px solid #d6e9c6;
      padding: 12px 16px;
      border-radius: 8px;
      margin: 10px 0;
      color: #3c763d;
      font-weight: 700;
      font-size: 1rem;
    }
  </style>
</head>
<body>
  <div class="container">

    <div class="header">냉장고 채우기</div>

    <div><a href="/upload"> 이미지로 식재료 등록하기</a></div>

    <div class="form-section">
      <form id="searchForm" onsubmit="return searchFoodList()">
        <div class="form-row">
          <div class="form-group">
            <label for="ingredient">구매 식재료를 입력하세요</label>
            <input type="text" id="ingredient" name="ingredient" placeholder="예: 바나나" required />
          </div>
          <div class="form-group">
            <label for="pur_date">구매일자</label>
            <input type="date" id="pur_date" name="pur_date" required />
          </div>
        </div>

        <div class="action-button-section">
          <button type="button" class="btn-register" onclick="registerFood()">등록</button>
          <button type="submit" class="btn-view">조회</button>
          <button type="button" onclick="clearSearch()">조회 초기화</button>
        </div>
      </form>
    </div>

    <div class="table-container">
      <div class="table-header">
        <div><input type="checkbox" id="selectAll" class="checkbox" onchange="toggleAllCheckboxes()" /></div>
        <div>식품명</div>
        <div>구매일자</div>
        <div>액션</div>
      </div>

      {% for item in result %}
      <div class="table-row">
        <div><input type="checkbox" class="item-checkbox" /></div>
        <div>{{ item.ingredient }}</div>
        <div>{{ item.purDate }}</div>
        <div>
          <button type="button" class="btn-delete" onclick="deleteIngredient({{ item.indexNo }})">음식물 버리기</button>
        </div>
      </div>
      {% endfor %}

    </div>

    <div class="bottom-section">
      <button class="bottom-btn" onclick="recommendMeal()">냉장고에 있는 식재료로 식단 추천받기</button>
      <button class="bottom-btn" onclick="checkAvailableRecipes()">식재료 사용 가능 여부 확인하기</button>
    </div>

    <div id="recipe-check-result" style="margin-top: 20px;"></div>

  </div>

  <script>
    // 오늘 날짜 기본값 설정
    document.getElementById('pur_date').valueAsDate = new Date();

    function registerFood() {
      const ingredient = document.getElementById('ingredient').value.trim();
      const purDate = document.getElementById('pur_date').value;

      if (!ingredient || !purDate) {
        alert('식재료와 구매일자를 모두 입력해주세요.');
        return;
      }

      fetch('/api/refrigerator', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          userNo: 1,
          ingredient: ingredient,
          purDate: purDate
        })
      })
        .then(response => {
          if (response.ok) {
            alert('식재료가 등록되었습니다!');
            location.reload();
          } else {
            alert('등록 실패: 서버 오류');
          }
        })
        .catch(error => {
          console.error('등록 중 오류 발생:', error);
          alert('등록 실패: 네트워크 오류');
        });
    }

    function searchFoodList() {
      const ingredient = document.getElementById('ingredient').value.trim();
      const purDate = document.getElementById('pur_date').value;

      let query = '?';
      if (ingredient) query += `ingredient=${encodeURIComponent(ingredient)}&`;
      // 아래 pur_date → purDate 로 수정했습니다.
      if (purDate) query += `purDate=${encodeURIComponent(purDate)}&`;

      window.location.href = '/' + query.slice(0, -1);

      return false; // 폼 제출 막음
    }

    function clearSearch() {
      document.getElementById('ingredient').value = '';
      document.getElementById('pur_date').valueAsDate = new Date();

      window.location.href = '/';
    }

    function recommendMeal() {
      const selectedItems = document.querySelectorAll('.item-checkbox:checked');
      const selectedIngredients = [];

      selectedItems.forEach(item => {
        const row = item.closest('.table-row');
        const ingredient = row.children[1].textContent;
        selectedIngredients.push(ingredient);
      });

      if (selectedIngredients.length === 0) {
        alert('식재료를 선택해주세요.');
        return;
      }

      alert(`선택된 식재료: ${selectedIngredients.join(', ')}\n\n식단 추천 기능 실행!`);
    }

    function checkAvailableRecipes() {
      const selectedItems = document.querySelectorAll('.item-checkbox:checked');
      const selectedIngredients = [];

      selectedItems.forEach(item => {
        const row = item.closest('.table-row');
        const ingredient = row.children[1].textContent.trim();
        selectedIngredients.push(ingredient);
      });

      if (selectedIngredients.length === 0) {
        alert('식재료를 선택해주세요.');
        return;
      }

      fetch('/can_eat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ingredients: selectedIngredients })
      })
        .then(response => response.json())
        .then(data => {
          const resultDiv = document.getElementById('recipe-check-result');
          resultDiv.innerHTML = '';

          if (data.error) {
            resultDiv.innerHTML = `<p style="color:red;">오류 발생: ${data.error}</p>`;
          } else {
            data.results.forEach(msg => {
              const p = document.createElement('p');
              p.textContent = msg;
              resultDiv.appendChild(p);
            });
          }
        })
        .catch(error => {
          console.error("요청 실패:", error);
          alert("서버 요청 중 오류가 발생했습니다.");
        });
    }

    function toggleAllCheckboxes() {
      const selectAll = document.getElementById('selectAll');
      document.querySelectorAll('.item-checkbox').forEach(cb => cb.checked = selectAll.checked);
    }

    function deleteIngredient(indexNo) {
      if (!confirm('정말 삭제하시겠습니까?')) return;
      fetch(`/delete_ingredient/${indexNo}`, { method: 'DELETE' })
        .then(response => response.json())
        .then(data => {
          if (data.message) {
            alert(data.message);
            location.reload();
          } else {
            alert(data.error || '삭제 실패');
          }
        })
        .catch(err => {
          alert('오류 발생');
          console.error(err);
        });
    }
  </script>
</body>
</html>
